upstream php_fpm {
    server backend:9000;
}

limit_req_zone $binary_remote_addr zone=api_general:10m rate=60r/m;
limit_req_zone $binary_remote_addr zone=api_auth:10m    rate=10r/m;
limit_req_zone $binary_remote_addr zone=api_upload:10m  rate=5r/m;
limit_conn_zone $binary_remote_addr zone=conn_limit:10m;

server {
    listen 80;
    server_name laughtube.ca www.laughtube.ca;

    client_max_body_size 500M;

    client_body_timeout   12s;
    client_header_timeout 12s;
    keepalive_timeout     15s;
    send_timeout          10s;

    server_tokens off;

    add_header X-Frame-Options "SAMEORIGIN"            always;
    add_header X-Content-Type-Options "nosniff"        always;
    add_header X-XSS-Protection "1; mode=block"        always;
    add_header Referrer-Policy "strict-origin-when-cross-origin" always;
    add_header Permissions-Policy "camera=(), microphone=(), geolocation=()" always;

    if ($request_method !~ ^(GET|POST|PUT|PATCH|DELETE|OPTIONS)$) {
        return 405;
    }

    if ($http_user_agent ~* (nikto|sqlmap|nmap|masscan|zgrab|dirbuster|gobuster|wfuzz)) {
        return 403;
    }

    if ($query_string ~* "(union|select|insert|drop|delete|update|exec|script|javascript|vbscript|onload|onerror)") {
        return 403;
    }

    location ~* \.(env|git|sql|bak|backup|log|tfstate)$ {
        return 404;
    }

    location /assets/ {
        root /var/www/frontend;
        expires 1y;
        add_header Cache-Control "public, immutable";
        try_files $uri =404;
    }

    location / {
        root /var/www/frontend;
        index index.html;
        try_files $uri $uri/ /index.html;
    }

    location /uploads/ {
        alias /var/www/html/public/uploads/;
        expires 30d;
        add_header Cache-Control "public, immutable";
        location ~* \.(php|php5|phtml|sh|py|pl)$ {
            return 403;
        }
    }

    location ^~ /api/ {
        limit_conn conn_limit 20;

        location ~* ^/api/(login|register|forgot-password|reset-password) {
            limit_req zone=api_auth burst=5 nodelay;
            limit_req_status 429;
            include fastcgi_params;
            fastcgi_pass php_fpm;
            fastcgi_param SCRIPT_FILENAME /var/www/html/public/index.php;
            fastcgi_param REQUEST_URI $request_uri;
            fastcgi_param QUERY_STRING $query_string;
        }

        location ~* ^/api/videos/upload {
            limit_req zone=api_upload burst=3 nodelay;
            limit_req_status 429;
            include fastcgi_params;
            fastcgi_pass php_fpm;
            fastcgi_param SCRIPT_FILENAME /var/www/html/public/index.php;
            fastcgi_param REQUEST_URI $request_uri;
            fastcgi_param QUERY_STRING $query_string;
        }

        limit_req zone=api_general burst=20 nodelay;
        limit_req_status 429;

        include fastcgi_params;
        fastcgi_pass php_fpm;
        fastcgi_param SCRIPT_FILENAME /var/www/html/public/index.php;
        fastcgi_param REQUEST_URI $request_uri;
        fastcgi_param QUERY_STRING $query_string;
    }

    location ~ \.php$ {
        root /var/www/html/public;
        include fastcgi_params;
        fastcgi_index index.php;
        fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
        fastcgi_pass php_fpm;
        fastcgi_read_timeout 600s;
    }
}